<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#00E5B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="signight">
  <meta name="description" content="دستیار هوشمند معاملات با تحلیل تکنیکال پیشرفته">
  
  <title>signight</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>
        <img src="icons/icon-96.png" alt="signight" style="width:22px;height:22px;object-fit:contain;display:inline-block;vertical-align:middle;">
        signight
      </h1>
      <div class="header-actions">
        <div class="status-bar">
          <span class="status-dot"></span>
          <span id="lastUpdate">--:--</span>
        </div>
        <button id="installBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          نصب
        </button>
      </div>
    </header>
    
    <!-- Update Banner -->
    <div class="update-banner" id="updateBanner" aria-live="polite">
      <div class="update-text">نسخه جدید اپلیکیشن آماده است</div>
      <div class="update-actions">
        <button id="updateRefreshBtn" class="update-btn">به‌روزرسانی</button>
        <button id="updateDismissBtn" class="update-dismiss" aria-label="بستن اعلان بروزرسانی">×</button>
      </div>
    </div>
    
    <!-- Search Box -->
    <div class="search-box">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input type="text" id="searchInput" placeholder="جستجوی نماد... (مثل BTC, ETH, DOGE)">
      <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Watchlist Tabs -->
    <div class="tabs" id="watchlistTabs">
      <!-- Generated by JS -->
    </div>
    
    <!-- Capital Settings -->
    <div class="capital-box">
      <div class="capital-row-main">
        <div class="capital-field">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            سرمایه (USDT)
          </label>
          <input type="number" id="capitalInput" value="1000" min="1">
        </div>
        <div class="capital-field">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="20" x2="12" y2="10"></line>
              <line x1="18" y1="20" x2="18" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
            درصد ورود
          </label>
          <select id="riskPercent">
            <option value="10">10%</option>
            <option value="20">20%</option>
            <option value="30">30%</option>
            <option value="50">50%</option>
            <option value="100">100%</option>
          </select>
        </div>
        <div class="capital-field">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
            اهرم (Leverage)
          </label>
          <select id="leverageSelect">
            <option value="auto">خودکار</option>
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="3">3x</option>
            <option value="5">5x</option>
            <option value="7">7x</option>
            <option value="10">10x</option>
            <option value="15">15x</option>
            <option value="20">20x</option>
            <option value="25">25x</option>
            <option value="50">50x</option>
            <option value="75">75x</option>
            <option value="100">100x</option>
            <option value="125">125x</option>
          </select>
        </div>
        <div class="capital-amount">
          <span class="amount-label">مبلغ ورود:</span>
          <span class="amount-value" id="entryAmount">$100</span>
        </div>
      </div>
      <div class="capital-row-secondary">
        <div class="capital-field">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20V10"></path>
              <path d="M18 20V4"></path>
              <path d="M6 20v-4"></path>
            </svg>
            استراتژی
          </label>
          <select id="strategySelect">
            <option value="default">پیش‌فرض (متوازن)</option>
            <option value="conservative">محافظه‌کارانه</option>
            <option value="trend_following">پیروی از روند</option>
          </select>
        </div>
        <div class="capital-field notification-field">
          <label>
            <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            اعلان
          </label>
          <label class="switch">
            <input type="checkbox" id="notificationToggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <button class="save-btn" id="saveSettings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          ذخیره
        </button>
      </div>
    </div>
    
    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab" data-view="scanner" id="tabScanner">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
        </svg>
        پیشنهادات
      </button>
      <button class="view-tab active" data-view="signal" id="tabSignal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        جزئیات
      </button>
      <button class="view-tab" data-view="chart" id="tabChart">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        نمودار
      </button>
      <button class="view-tab" data-view="monteCarlo" id="tabMonteCarlo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        مونته کارلو
      </button>
    </div>
    
    <!-- Signal View (Asset Panel) -->
    <div class="view-content active" id="viewSignal">
      <div class="asset-panel" id="assetPanel">
        <div class="loading">در حال بارگذاری...</div>
      </div>
    </div>
    
    <!-- Chart View -->
    <div class="view-content" id="viewChart">
      <div class="chart-container">
        <div class="chart-header">
          <span class="chart-title" id="chartTitle">نمودار قیمت</span>
          <div class="chart-controls">
            <button class="chart-btn active" id="btnEMA" onclick="toggleChartIndicator('ema')">EMA</button>
            <button class="chart-btn active" id="btnBB" onclick="toggleChartIndicator('bb')">BB</button>
            <button class="chart-btn active" id="btnVolume" onclick="toggleChartIndicator('volume')">Vol</button>
            <button class="chart-btn" onclick="resetChartView()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="priceChart"></canvas>
        </div>
        <div class="chart-timeframes">
          <button class="tf-btn" data-tf="30m">30m</button>
          <button class="tf-btn active" data-tf="1h">1H</button>
          <button class="tf-btn" data-tf="4h">4H</button>
          <button class="tf-btn" data-tf="1d">1D</button>
        </div>
      </div>
    </div>
    
    <!-- Suggestions View (Auto Scanner) -->
    <div class="view-content" id="viewScanner">
      <div class="scanner-container">
        <!-- Header with timer -->
        <div class="suggestions-header" style="background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:10px;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2">
                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
              <span style="color:var(--text1);font-weight:600;font-size:16px;">پیشنهادات هوشمند</span>
            </div>
          </div>
          <p style="margin:10px 0 0;font-size:13px;color:var(--text2);">۱۲ نماد پشتیبانی شده • به‌روزرسانی خودکار هر ۱۰ ثانیه</p>
        </div>
        
        <!-- Results list -->
        <div id="scannerResults" style="display:none;">
          <div id="scannerResultsList"></div>
        </div>
        
        <!-- No results state -->
        <div id="noSuggestionsState" style="display:none;text-align:center;padding:60px 20px;color:var(--text2);">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 20px;opacity:0.5;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <h3 style="margin:0 0 10px;color:var(--text1);">پیشنهادی یافت نشد</h3>
          <p style="margin:0 0 20px;font-size:14px;">سیگنال قوی با امتیاز ۶+ یافت نشد</p>
          <button onclick="startAutoSuggestions()" style="background:var(--card);color:var(--text1);border:1px solid var(--border);padding:10px 24px;border-radius:8px;font-size:14px;cursor:pointer;font-family:inherit;">
            جستجوی مجدد
          </button>
        </div>
      </div>
    </div>
    
    <!-- Monte Carlo View -->
    <div class="view-content" id="viewMonteCarlo">
      <div class="monte-carlo-container">
        <!-- تنظیمات تست Monte Carlo -->
        <div class="capital-box monte-settings-box">
          <div class="capital-row-main monte-settings-row" style="flex-wrap:wrap;row-gap:10px;margin-bottom:8px;border-bottom:none;padding-bottom:0;">
            <div class="capital-field monte-field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                تعداد شبیه‌سازی
              </label>
              <select id="monteSimulations">
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000" selected>1000</option>
                <option value="2000">2000</option>
              </select>
            </div>
            <div class="capital-field monte-field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 12h16"></path>
                  <path d="M12 4v16"></path>
                </svg>
                سطح اطمینان
              </label>
              <select id="monteConfidence">
                <option value="90">90%</option>
                <option value="95" selected>95%</option>
                <option value="99">99%</option>
              </select>
            </div>
            <div class="capital-field monte-field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="#00E5B0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 17 9 11 13 15 21 7"></polyline>
                </svg>
                سناریو
              </label>
              <select id="monteScenario">
                <option value="normal" selected>نرمال</option>
                <option value="conservative">محافظه‌کارانه</option>
                <option value="aggressive">تهاجمی</option>
              </select>
            </div>
          </div>
          <div class="capital-row-main" style="justify-content:center;border-top:1px solid var(--border);padding-top:10px;border-bottom:none;margin-bottom:0;">
            <button class="save-btn" onclick="runMonteCarloTest()" id="runMonteCarloBtn" style="padding:12px 24px;font-size:15px;min-width:60%;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;margin-left:8px;">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              شروع تست
            </button>
          </div>
        </div>

        <!-- پیام خطا برای Monte Carlo -->
        <div id="monteCarloError" style="display:none;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.5);color:#fecaca;border-radius:10px;padding:10px 12px;margin:12px 0;font-size:13px;"></div>

        <!-- Placeholder: قبل از اجرای تست -->
        <div id="monteCarloPlaceholder" style="text-align:center;padding:40px 20px;color:var(--text2);">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 20px;opacity:0.5;">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          <h3 style="margin:0 0 10px;color:var(--text1);">تحلیل Monte Carlo</h3>
          <p style="margin:0 0 6px;font-size:14px;">این ابزار با استفاده از Walk-Forward و شبیه‌سازی Monte Carlo، استحکام استراتژی را بررسی می‌کند.</p>
          <p style="margin:0;font-size:12px;color:var(--text3);">بالا دقت تست را با تعداد شبیه‌سازی و سطح اطمینان تنظیم کنید، سپس روی «شروع تست» بزنید.</p>
        </div>
        
        <!-- Progress: هنگام اجرای تست -->
        <div id="monteCarloProgress" style="display:none;background:var(--card);border-radius:12px;padding:16px;margin:16px 0;border:1px solid var(--border);">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <div style="width:24px;height:24px;border:3px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
            <span style="color:var(--text1);font-weight:600;" id="monteCarloProgressText">در حال اجرای تست‌ها...</span>
          </div>
          <div style="background:var(--bg2);border-radius:8px;height:8px;overflow:hidden;">
            <div id="monteCarloProgressBar" style="background:var(--teal);height:100%;width:0%;transition:width 0.3s;"></div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--text2);" id="monteCarloStatusText">آماده‌سازی...</div>
        </div>
        
        <!-- Results: بعد از اتمام تست -->
        <div id="monteCarloResults" style="display:none;">
          <!-- کارت نتیجه‌گیری کلی (Verdict) -->
          <div id="monteCarloVerdict" style="margin-bottom:24px;"></div>
          
          <!-- Grid کارت‌های نتایج Walk-Forward -->
          <h4 style="margin:24px 0 16px;color:var(--text1);font-size:18px;display:flex;align-items:center;gap:8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            نتایج Walk-Forward
          </h4>
          <div class="stats-grid" id="walkForwardStats"></div>
          
          <!-- Grid کارت‌های نتایج Monte Carlo -->
          <h4 style="margin:24px 0 16px;color:var(--text1);font-size:18px;display:flex;align-items:center;gap:8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            نتایج Monte Carlo
          </h4>
          <div class="stats-grid" id="monteCarloStats"></div>
        </div>
      </div>
    </div>
  </div>
  
    <!-- AI Advisor Sticky Section -->
    <div id="aiAdvisorSticky" style="display:none;position:sticky;bottom:0;left:0;right:0;z-index:100;background:var(--bg);border-top:1px solid var(--border);padding:8px 16px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);">
      <button id="aiAdvisorButton" onclick="handleAIPromptClick(null)" style="width:100%;padding:10px 16px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;font-family:'Vazirmatn',sans-serif;display:flex;align-items:center;justify-content:center;gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
        دریافت پرامپت تحلیل
      </button>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- Scripts -->
  <script src="core.js"></script>
  <script src="chart.js"></script>
  <script src="monte-carlo.js"></script>
  <script src="app.js"></script>
</body>
</html>
