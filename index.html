<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#00E5B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="signight">
  <meta name="description" content="دستیار هوشمند معاملات با تحلیل تکنیکال پیشرفته">
  
  <title>signight</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>
        <img src="icons/icon-96.png" alt="signight" style="width:22px;height:22px;object-fit:contain;display:inline-block;vertical-align:middle;">
        signight
      </h1>
      <div class="header-actions">
        <div class="status-bar">
          <span class="status-dot"></span>
          <span id="lastUpdate">--:--</span>
        </div>
        <button id="installBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          نصب
        </button>
      </div>
    </header>
    
    <!-- Update Banner -->
    <div class="update-banner" id="updateBanner" aria-live="polite">
      <div class="update-text">نسخه جدید اپلیکیشن آماده است</div>
      <div class="update-actions">
        <button id="updateRefreshBtn" class="update-btn">به‌روزرسانی</button>
        <button id="updateDismissBtn" class="update-dismiss" aria-label="بستن اعلان بروزرسانی">×</button>
      </div>
    </div>
    
    <!-- Search Box -->
    <div class="search-box">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input type="text" id="searchInput" placeholder="جستجوی نماد... (مثل BTC, ETH, DOGE)">
      <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Watchlist Tabs -->
    <div class="tabs" id="watchlistTabs">
      <!-- Generated by JS -->
    </div>
    
    <!-- Prompt Section -->
    <div class="prompt-section">
      <div class="prompt-controls">
        <button id="getPromptBtn" class="prompt-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
          </svg>
          <span id="promptBtnText">دریافت پرامپت</span>
        </button>
        <select id="promptSymbolSelect" class="prompt-select-compact" title="تغییر نماد">
          <!-- Options will be populated by JS -->
        </select>
      </div>
    </div>
    
    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab active" data-view="signal" id="tabSignal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        جزئیات
      </button>
      <button class="view-tab" data-view="chart" id="tabChart">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        نمودار
      </button>
    </div>
    
    <!-- Signal View (Asset Panel) -->
    <div class="view-content active" id="viewSignal">
      <div class="dashboard-mode-toggle-container">
        <label class="dashboard-mode-toggle">
          <input type="checkbox" id="dashboardModeToggle" />
          <span class="toggle-slider"></span>
          <span class="toggle-label">
            <span class="toggle-text-simple">ساده</span>
            <span class="toggle-text-professional">حرفه‌ای</span>
          </span>
        </label>
      </div>
      <div class="asset-panel" id="assetPanel">
        <div class="loading">در حال بارگذاری...</div>
      </div>
    </div>
    
    <!-- Chart View -->
    <div class="view-content" id="viewChart">
      <div class="chart-container">
        <div class="chart-header">
          <span class="chart-title" id="chartTitle">نمودار قیمت</span>
          <div class="chart-controls">
            <button class="chart-btn active" id="btnEMA" onclick="toggleChartIndicator('ema')">EMA</button>
            <button class="chart-btn active" id="btnBB" onclick="toggleChartIndicator('bb')">BB</button>
            <button class="chart-btn active" id="btnVolume" onclick="toggleChartIndicator('volume')">Vol</button>
            <button class="chart-btn" onclick="resetChartView()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="priceChart"></canvas>
        </div>
        <div class="chart-timeframes">
          <button class="tf-btn" data-tf="30m">30m</button>
          <button class="tf-btn active" data-tf="1h">1H</button>
          <button class="tf-btn" data-tf="4h">4H</button>
          <button class="tf-btn" data-tf="1d">1D</button>
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- Prompt Modal -->
  <div class="prompt-modal" id="promptModal">
    <div class="prompt-modal-content">
      <div class="prompt-modal-header">
        <h3>پرامپت تولید شده</h3>
        <button class="prompt-modal-close" id="promptModalClose">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="prompt-modal-body">
        <textarea id="promptTextarea" readonly></textarea>
      </div>
      <div class="prompt-modal-footer">
        <button class="prompt-copy-btn" id="promptCopyBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
          </svg>
          کپی پرامپت
        </button>
      </div>
    </div>
  </div>
  
  <!-- External Libraries (Local) -->
  <!-- ccxt library for exchange data -->
  <script src="libs/ccxt.browser.js" 
          onload="console.log('ccxt loaded successfully from local file')" 
          onerror="console.error('Failed to load ccxt from local file'); loadCcxtFallback()"></script>
  <!-- technicalindicators library for technical analysis -->
  <!-- Load from esm.sh as ESM module (async) -->
  <script type="module">
    (async function() {
      try {
        // Try to load from esm.sh as ESM module
        const technicalIndicatorsModule = await import('https://esm.sh/technicalindicators@3.1.0');
        window.technicalIndicators = technicalIndicatorsModule.default || technicalIndicatorsModule;
        console.log('technicalindicators loaded successfully from esm.sh');
        // Dispatch event to notify that technicalIndicators is ready
        window.dispatchEvent(new CustomEvent('technicalIndicatorsLoaded'));
      } catch (e) {
        console.error('Failed to load technicalindicators from esm.sh:', e);
        // Fallback: try to load from local file or CDN
        if (typeof loadTechnicalIndicatorsFallback === 'function') {
          loadTechnicalIndicatorsFallback();
        }
      }
    })();
  </script>
  
  <!-- Fallback scripts -->
  <script>
    let ccxtLoaded = false;
    let technicalIndicatorsLoaded = false;
    
    function loadCcxtFallback() {
      if (ccxtLoaded) return;
      console.log('Loading ccxt fallback from CDN...');
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/ccxt/dist/ccxt.browser.js';
      script.onload = () => {
        console.log('ccxt loaded from jsdelivr fallback');
        ccxtLoaded = true;
      };
      script.onerror = () => {
        console.error('Failed to load ccxt from jsdelivr, trying esm.sh...');
        loadCcxtESM();
      };
      document.head.appendChild(script);
    }
    
    function loadCcxtESM() {
      const script = document.createElement('script');
      script.type = 'module';
      script.textContent = `
        import ccxt from 'https://esm.sh/ccxt@4.0.0';
        window.ccxt = ccxt;
        console.log('ccxt loaded from esm.sh');
      `;
      document.head.appendChild(script);
    }
    
    function loadTechnicalIndicatorsFallback() {
      if (technicalIndicatorsLoaded) return;
      console.log('Loading technicalindicators fallback from CDN...');
      const urls = [
        'https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/technicalindicators.min.js',
        'https://unpkg.com/technicalindicators@3.1.0/dist/technicalindicators.min.js',
        'https://cdn.jsdelivr.net/npm/technicalindicators/dist/technicalindicators.min.js'
      ];
      
      let currentUrlIndex = 0;
      
      function tryNextUrl() {
        if (currentUrlIndex >= urls.length) {
          console.error('Failed to load technicalindicators from all CDN sources, trying esm.sh...');
          loadTechnicalIndicatorsESM();
          return;
        }
        
        const script = document.createElement('script');
        script.src = urls[currentUrlIndex];
        script.onload = () => {
          console.log('technicalindicators loaded from CDN fallback:', urls[currentUrlIndex]);
          technicalIndicatorsLoaded = true;
          // Ensure it's available globally
          if (typeof technicalIndicators === 'undefined' && window.technicalIndicators) {
            window.technicalIndicators = window.technicalIndicators;
          }
        };
        script.onerror = () => {
          currentUrlIndex++;
          tryNextUrl();
        };
        document.head.appendChild(script);
      }
      
      tryNextUrl();
    }
    
    function loadTechnicalIndicatorsESM() {
      const script = document.createElement('script');
      script.type = 'module';
      script.textContent = `
        import * as technicalIndicators from 'https://esm.sh/technicalindicators@3.1.0';
        window.technicalIndicators = technicalIndicators;
        console.log('technicalindicators loaded from esm.sh');
      `;
      document.head.appendChild(script);
    }
    
    // Check if libraries are already loaded
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (typeof ccxt === 'undefined') {
          console.warn('ccxt not loaded after page load, trying fallback...');
          loadCcxtFallback();
        }
        if (typeof technicalIndicators === 'undefined' && typeof window.technicalIndicators === 'undefined') {
          console.warn('technicalindicators not loaded after page load, trying fallback...');
          loadTechnicalIndicatorsFallback();
        }
      }, 2000);
    });
  </script>
  
  <!-- Scripts -->
  <!-- counter-targeting.js must load before app.js -->
  <script src="counter-targeting.js"></script>
  <!-- app.js must load first to define DEFAULT_SYMBOLS -->
  <script src="app.js"></script>
  <script src="scoring-engine.js"></script>
  <script src="core.js"></script>
  <script src="chart.js"></script>
  
  <!-- Analysis Engine - Load directly as module -->
  <script type="module" src="analysis-engine.js"></script>
  
  <!-- Analysis Engine - Status checker -->
  <script>
    // Check if AnalysisEngine loaded successfully
    (function() {
      // Wait for module script to execute
      setTimeout(function() {
        if (typeof window.AnalysisEngine === 'undefined') {
          console.error('[AnalysisEngine] Class not found after module script load.');
          console.error('[AnalysisEngine] Possible issues:');
          console.error('  1. File analysis-engine.js does not exist');
          console.error('  2. Browser cache needs to be cleared (Ctrl+F5)');
          console.error('  3. File path is incorrect');
          console.error('  4. JavaScript syntax error in analysis-engine.js');
          
          // Dispatch error event
          window.dispatchEvent(new CustomEvent('analysisEngineError', { 
            detail: new Error('AnalysisEngine class not found. Check browser console for details.') 
          }));
        } else {
          console.log('[AnalysisEngine] Successfully loaded!');
        }
      }, 3000);
    })();
  </script>
  
  <!-- Analysis Engine Module -->
  <script type="module">
    // Wait for libraries to be available before loading the module
    function waitForLibraries(maxWait = 20000) {
      return new Promise((resolve, reject) => {
        const startTime = Date.now();
        let checkCount = 0;
        
        const checkLibraries = () => {
          checkCount++;
          const ccxtLoaded = typeof ccxt !== 'undefined';
          // Check different possible names for technicalindicators
          const tiLoaded = typeof technicalIndicators !== 'undefined' || 
                          typeof window.technicalIndicators !== 'undefined' ||
                          typeof window.TechnicalIndicators !== 'undefined';
          
          if (checkCount % 10 === 0) {
            console.log(`Checking libraries (attempt ${checkCount}): ccxt=${ccxtLoaded}, technicalIndicators=${tiLoaded}`);
          }
          
          if (ccxtLoaded && tiLoaded) {
            console.log('Both libraries are loaded successfully!');
            // Ensure technicalIndicators is available globally
            if (typeof technicalIndicators === 'undefined' && window.technicalIndicators) {
              window.technicalIndicators = window.technicalIndicators;
            }
            resolve();
          } else if (Date.now() - startTime > maxWait) {
            const errorMsg = `Timeout waiting for libraries. ccxt: ${ccxtLoaded ? 'loaded' : 'NOT loaded'}, technicalIndicators: ${tiLoaded ? 'loaded' : 'NOT loaded'}`;
            console.error(errorMsg);
            reject(new Error(errorMsg));
          } else {
            setTimeout(checkLibraries, 200);
          }
        };
        
        // Start checking after a short delay to allow scripts to load
        setTimeout(checkLibraries, 500);
      });
    }

    async function loadLibrariesDynamically() {
      try {
        // Try to load ccxt dynamically if not available
        if (typeof ccxt === 'undefined') {
          console.log('Loading ccxt dynamically...');
          try {
            const ccxtModule = await import('https://esm.sh/ccxt@4.0.0');
            window.ccxt = ccxtModule.default || ccxtModule;
            console.log('ccxt loaded dynamically from esm.sh');
          } catch (e) {
            console.error('Failed to load ccxt dynamically:', e);
            throw new Error('Could not load ccxt library');
          }
        }
        
        // Try to load technicalindicators dynamically if not available
        if (typeof technicalIndicators === 'undefined' && typeof window.technicalIndicators === 'undefined') {
          console.log('Loading technicalindicators dynamically...');
          try {
            const tiModule = await import('https://esm.sh/technicalindicators@3.1.0');
            window.technicalIndicators = tiModule.default || tiModule;
            console.log('technicalindicators loaded dynamically from esm.sh');
          } catch (e) {
            console.error('Failed to load technicalindicators dynamically:', e);
            throw new Error('Could not load technicalindicators library');
          }
        }
      } catch (error) {
        console.error('Error loading libraries dynamically:', error);
        throw error;
      }
    }

    async function loadAnalysisEngineAsScript() {
      return new Promise(async (resolve, reject) => {
        // First check if already loaded (from direct script tag in HTML)
        if (window.AnalysisEngine) {
          console.log('AnalysisEngine already loaded from HTML');
          resolve();
          return;
        }
        
        let resolved = false;
        
        // Listen for module loaded event
        const eventHandler = () => {
          if (!resolved && window.AnalysisEngine) {
            resolved = true;
            window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
            console.log('AnalysisEngine loaded (detected via event)');
            resolve();
          }
        };
        window.addEventListener('analysisEngineModuleLoaded', eventHandler);
        
        // Wait for the direct script tag to load (give it more time)
        let attempts = 0;
        const checkDirectLoad = setInterval(() => {
          attempts++;
          if (window.AnalysisEngine && !resolved) {
            resolved = true;
            clearInterval(checkDirectLoad);
            window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
            console.log('AnalysisEngine loaded from direct script tag');
            resolve();
            return;
          }
          if (attempts >= 100) { // Wait up to 10 seconds for module script
            clearInterval(checkDirectLoad);
            if (!window.AnalysisEngine && !resolved) {
              // Module script didn't work, try dynamic loading
              console.warn('Direct module script did not load AnalysisEngine, trying dynamic script tag...');
              loadDynamically();
            }
          }
        }, 100);
        
        function loadDynamically() {
          console.log('Loading AnalysisEngine dynamically...');
          
          // Check if script already exists
          const existingScript = document.querySelector('script[src="./analysis-engine.js"], script[src="analysis-engine.js"]');
          if (existingScript) {
            // Script exists, wait for it to load, then try fallback if needed
            let waitAttempts = 0;
            const waitInterval = setInterval(async () => {
              waitAttempts++;
              if (window.AnalysisEngine && !resolved) {
                resolved = true;
                clearInterval(waitInterval);
                window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
                console.log('AnalysisEngine loaded from existing script');
                resolve();
              } else if (waitAttempts >= 50) {
                // After 5 seconds, give up
                clearInterval(waitInterval);
                if (!resolved && !window.AnalysisEngine) {
                  resolved = true;
                  window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
                  reject(new Error('AnalysisEngine script exists but class not found after 5 seconds. Check browser console for JavaScript errors.'));
                }
              }
            }, 100);
            return;
          }
          
          // Note: fetch() doesn't work with file:// protocol, so we only use script tags
          // The module script tag should handle loading
          
          // Create new script tag
          const script = document.createElement('script');
          script.type = 'module';
          script.src = './analysis-engine.js';
          
          // Check periodically if AnalysisEngine is available
          const checkInterval = setInterval(() => {
            if (window.AnalysisEngine && !resolved) {
              resolved = true;
              clearInterval(checkInterval);
              clearTimeout(timeout);
              window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
              console.log('AnalysisEngine loaded successfully via dynamic script tag');
              resolve();
            }
          }, 100);
          
          // Timeout after 15 seconds
          const timeout = setTimeout(() => {
            clearInterval(checkInterval);
            if (!window.AnalysisEngine && !resolved) {
              resolved = true;
              window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
              reject(new Error('Timeout waiting for AnalysisEngine to load. Make sure analysis-engine.js exists and check browser console for errors.'));
            }
          }, 15000);
          
          script.onerror = (error) => {
            if (!resolved) {
              resolved = true;
              clearInterval(checkInterval);
              clearTimeout(timeout);
              window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
              console.error('Script load error:', error);
              reject(new Error('Failed to load analysis-engine.js script. Check browser console for details.'));
            }
          };
          
          script.onload = () => {
            // Give it a moment to execute the module code
            setTimeout(() => {
              if (window.AnalysisEngine && !resolved) {
                resolved = true;
                clearInterval(checkInterval);
                clearTimeout(timeout);
                window.removeEventListener('analysisEngineModuleLoaded', eventHandler);
                console.log('AnalysisEngine loaded successfully');
                resolve();
              }
            }, 500);
          };
          
          document.head.appendChild(script);
        }
      });
    }

    async function loadAnalysisEngine() {
      try {
        console.log('Starting AnalysisEngine load process...');
        console.log('Initial state - ccxt:', typeof ccxt !== 'undefined' ? 'loaded' : 'not loaded');
        console.log('Initial state - technicalIndicators:', typeof technicalIndicators !== 'undefined' ? 'loaded' : 'not loaded');
        
        // First try to wait for libraries from CDN
        try {
          await waitForLibraries(10000); // Wait 10 seconds
          console.log('Libraries loaded from CDN');
        } catch (waitError) {
          console.warn('Libraries not loaded from CDN, trying dynamic import...', waitError);
          // If CDN fails, try dynamic import
          await loadLibrariesDynamically();
        }
        
        // Verify libraries are loaded
        if (typeof ccxt === 'undefined') {
          throw new Error('ccxt library is still not available after all attempts');
        }
        if (typeof technicalIndicators === 'undefined' && typeof window.technicalIndicators === 'undefined') {
          throw new Error('technicalindicators library is still not available after all attempts');
        }
        
        console.log('Libraries verified, loading AnalysisEngine...');
        
        // Load AnalysisEngine as a module script tag (works with file:// protocol)
        await loadAnalysisEngineAsScript();
        
        if (!window.AnalysisEngine) {
          throw new Error('Failed to load AnalysisEngine class');
        }
        
        window.analysisEngineReady = true;
        
        // Dispatch event to notify that engine is ready
        window.dispatchEvent(new CustomEvent('analysisEngineReady'));
        
        console.log('Analysis Engine module loaded successfully');
      } catch (error) {
        console.error('Error loading Analysis Engine:', error);
        window.dispatchEvent(new CustomEvent('analysisEngineError', { detail: error }));
      }
    }

    // Start loading immediately
    loadAnalysisEngine();
    
    // Also listen for when libraries might be loaded later
    window.addEventListener('load', function() {
      if (typeof window.AnalysisEngine === 'undefined') {
        console.log('Retrying AnalysisEngine load after page load...');
        loadAnalysisEngine();
      }
    });
  </script>

</body>
</html>
